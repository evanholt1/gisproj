<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Hurricane Map</title>

    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        #selectDiv {
            padding: 0;
            margin: 0;
            height: 20%;
            width: 100%;
        }
        
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 80%;
            width: 100%;
        }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">
    <script src="https://js.arcgis.com/4.9/"></script>

    <script>
        let hurricaneQuery = "";
        let hurricaneCsvLayer;
        require([
            "esri/Map",
            "esri/layers/CSVLayer",
            "esri/views/SceneView",
            "esri/core/urlUtils",
            "dojo/domReady"
        ], function(
            Map,
            CSVLayer,
            SceneView,
            urlUtils
        ) {
            var url =
                "https://gisproj.herokuapp.com/hurricane";

            var template = {
                title: "Hurricane Info",
                content: `Category {Category} {Nature} Hurricane occured {place} at {day}/{month}/{year}.,
part of Hurricane {Name}`
            };

            hurricaneCsvLayer = new CSVLayer({
                url: url,
                popupTemplate: template,
            });

            hurricaneCsvLayer.definitionExpression = hurricaneQuery;

            hurricaneCsvLayer.renderer = {
                type: "simple",
                symbol: {
                    type: "simple-marker",
                    color: [250, 250, 10],
                    outline: {
                        color: [255, 128, 128],
                        width: 0.5
                    }
                },
            };

            var map = new Map({
                basemap: "topo-vector",
                layers: [hurricaneCsvLayer],
                ground: "world-elevation"
            });

            var view = new SceneView({
                container: "viewDiv",
                center: [138, 35],
                scale: 50000000,
                map: map
            });
        });

        function changeQuery(buttonId) {
            if (buttonId == "Apply") {
                hurricaneQuery = `year >= ${String(document.getElementById("MinYear").value)} `;

                if (document.getElementById("Category").value)
                    hurricaneQuery += `and Category = ${String(document.getElementById("Category").value)}`;

                if (document.getElementById("Nature").value)
                    hurricaneQuery += ` and Nature = ' ${String(document.getElementById("Nature").value)}' `;

                console.log(document.getElementById("Category").value);
                console.log(document.getElementById("Nature").value);
                console.log(document.getElementById("MinYear").value);

            } else if (buttonId == "Clear") {
                hurricaneQuery = "year >= 1950";
            }

            hurricaneCsvLayer.definitionExpression = hurricaneQuery;
        }
    </script>
</head>

<body>
    <div class='container-fluid' id="selectDiv">
        <div class="row m-4">
            <div class="col-lg-1">
                <h2>Filters</h2>
            </div>
            <div class="col-lg-2">
                <select name="Category" id="Category" class="form-select">
                    <option selected value="">Category</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            <div class="col-lg-2">
                <select name="Nature" id="Nature" class="form-select">
                    <option selected value="">Nature</option>
                    <option value="TS">TS</option>
                    <option value="SS">SS</option>
                    <option value="ET">ET</option>
                    <option value="NR">NR</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label for="MinYear">Minimum Year</label>
                <input name="MinYear" id="MinYear" type="range" value="1950" min="1950" max="2015" oninput="this.nextElementSibling.value = this.value">
                <output>1950</output>
            </div>
            <div class="col-lg-1">
                <button id="Apply" type="button" class='btn btn-danger' onclick="changeQuery(this.id)">Apply</button>
            </div>
            <div class="col-lg-1">
                <button id="Clear" type="button" class="btn btn-secondary" onclick="changeQuery(this.id)">Clear</button>
            </div>

        </div>
        <hr style="width: 50%; margin-left: 25%;">
        <div class="row"></div>

    </div>
    <div id="viewDiv"></div>
</body>

</html>